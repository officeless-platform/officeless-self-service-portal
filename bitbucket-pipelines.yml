# Bitbucket Pipelines: build and deploy to Vercel
#
# Required repository variables (Repository settings → Pipelines → Repository variables):
#   VERCEL_TOKEN (secured) - create at https://vercel.com/account/tokens
#   VERCEL_ORG_ID - from Vercel project settings or .vercel/project.json
#   VERCEL_PROJECT_ID - from Vercel project settings or .vercel/project.json
#
# Vercel project: link this repo, set Root Directory to "." and
# Build Command to: npm ci && npm run build --workspace=apps/web

image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Build and deploy to Vercel (production)
          deployment: production
          caches:
            - node
            - npm
          script:
            - node --version
            - npm ci
            - npx vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            - npx vercel build --token=$VERCEL_TOKEN
            - npx vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
  default:
    - step:
        name: Build and deploy to Vercel (preview)
        deployment: preview
        caches:
          - node
          - npm
        script:
          - node --version
          - npm ci
          - npx vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          - npx vercel build --token=$VERCEL_TOKEN
          - npx vercel deploy --prebuilt --token=$VERCEL_TOKEN
